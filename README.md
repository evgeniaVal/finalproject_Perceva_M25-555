# ValutaTrade Hub

**ValutaTrade Hub** — это приложение для управления криптовалютным и фиатным портфелем с автоматическим обновлением курсов через внешние API.

## Демонстрация

[![asciicast](https://asciinema.org/a/zrfPSXiDy3DqvqB6.svg)](https://asciinema.org/a/zrfPSXiDy3DqvqB6)

*Демонстрация.*

## Описание проекта

ValutaTrade Hub позволяет:
- Регистрировать пользователей с безопасным хранением паролей (SHA-256 + соль)
- Управлять мультивалютными портфелями (USD, EUR, RUB, BTC, ETH, SOL и др.)
- Покупать и продавать валюту
- Автоматически обновлять курсы валют из CoinGecko и ExchangeRate-API
- Просматривать портфель в любой базовой валюте
- Отслеживать актуальность курсов с поддержкой TTL (Time To Live)

Проект построен с разделением на слои:
- **Core** — бизнес-логика (модели, usecases)
- **Infrastructure** — работа с данными и настройками
- **CLI** — интерфейс командной строки
- **Parser Service** — обновление курсов валют из внешних источников

## Структура проекта

```
finalproject_Perceva_M25-555/
├── main.py                      # Точка входа в приложение
├── Makefile                     # Команды для сборки и запуска
├── pyproject.toml               # Конфигурация Poetry и зависимости
├── README.md                    # Документация проекта
├── data/                        # Хранилище данных (JSON)
│   ├── users.json               # База пользователей
│   ├── portfolios.json          # Портфели пользователей
│   ├── rates.json               # Кэш курсов валют (TTL)
│   └── exchange_rates.json      # История всех курсов
├── logs/                        # Файлы логов
│   └── actions.log              # Логирование операций
└── valutatrade_hub/             # Основной пакет приложения
    ├── __init__.py
    ├── decorators.py            # Декораторы (@log_action)
    ├── logging_config.py        # Настройка логирования
    ├── cli/                     # Интерфейс командной строки
    │   ├── __init__.py
    │   └── interface.py         # Обработчики команд CLI
    ├── core/                    # Ядро бизнес-логики
    │   ├── __init__.py
    │   ├── currencies.py        # Справочник валют
    │   ├── exceptions.py        # Доменные исключения
    │   ├── models.py            # Модели (User, Wallet, Portfolio)
    │   ├── usecases.py          # Сценарии использования
    │   └── utils.py             # Вспомогательные функции
    ├── infra/                   # Инфраструктурный слой
    │   ├── __init__.py
    │   ├── database.py          # Менеджер базы данных (Singleton)
    │   └── settings.py          # Загрузчик настроек (Singleton)
    └── parser_service/          # Сервис обновления курсов
        ├── __init__.py
        ├── api_clients.py       # Клиенты для CoinGecko и ExchangeRate-API
        ├── config.py            # Конфигурация Parser Service
        ├── scheduler.py         # Планировщик обновлений
        ├── storage.py           # Хранилище курсов
        └── updater.py           # Координатор обновления курсов
```

## Установка и запуск

### Требования
- Python 3.12+
- Poetry

### 1. Установка зависимостей

```bash
make install
```

Эта команда установит все необходимые зависимости через Poetry:
- `prettytable` — для красивого отображения данных
- `requests` — для работы с API
- `ruff` — для проверки стиля кода

### 2. Настройка API ключей (опционально)

Для обновления курсов фиатных валют создайте файл `.env` в корне проекта:

```env
EXCHANGERATE_API_KEY=ваш_ключ_здесь
```

Получить бесплатный ключ можно на [exchangerate-api.com](https://www.exchangerate-api.com/).

> **Примечание:** Курсы криптовалют (BTC, ETH, SOL) получаются из CoinGecko без ключа.

### 3. Запуск приложения

```bash
make project
```

Или напрямую через Poetry:

```bash
poetry run project
```

## Использование

### Основные команды CLI

После запуска приложения доступны следующие команды:

#### 1. Регистрация пользователя

```bash
register --username alice --password secret123
```

#### 2. Вход в систему

```bash
login --username alice --password secret123
```

#### 3. Просмотр портфеля

```bash
show-portfolio --base USD
```

Пример вывода:
```
Портфель пользователя 'alice' (база: USD):
- BTC: 0.5000    →    29,668.61 USD
- EUR: 1000.00   →    1,078.60 USD
---------------------------------
ИТОГО: 30,747.21 USD
```

#### 4. Покупка валюты

```bash
buy --currency BTC --amount 0.1
```

Пример вывода:
```
Покупка выполнена: 0.1000 BTC по курсу 59,337.21 USD/BTC
Изменения в портфеле:
- BTC: было 0.0000 → стало 0.1000
Оценочная стоимость покупки: 5,933.72 USD
```

#### 5. Продажа валюты

```bash
sell --currency EUR --amount 100
```

Пример вывода:
```
Продажа выполнена: 100.0000 EUR по курсу 1.08 USD/EUR
Изменения в портфеле:
- EUR: было 1000.0000 → стало 900.0000
Оценочная выручка: 107.86 USD
```

#### 6. Получение курса валюты

```bash
get-rate --from BTC --to USD
```

Пример вывода:
```
Курс BTC→USD: 59337.21 (обновлено: 2026-01-14 10:35:00)
Обратный курс USD→BTC: 0.00001685
```

#### 7. Обновление курсов валют

```bash
update-rates
```

Обновить только из конкретного источника:
```bash
update-rates --source coingecko
update-rates --source exchangerate
```

#### 8. Просмотр кэшированных курсов

```bash
show-rates
```

Фильтрация по валюте:
```bash
show-rates --currency BTC
```

Топ-5 курсов:
```bash
show-rates --top 5
```

#### 9. Выход

```bash
exit
```

Или используйте `quit`, `q`, либо `Ctrl+C`.

## Кэш курсов и TTL

### Как работает кэширование

1. **Первый запрос** — курсы загружаются из внешних API и сохраняются в `data/rates.json`
2. **Последующие запросы** — используется кэш, если возраст данных < TTL (по умолчанию 3600 секунд = 1 час)
3. **Устаревший кэш** — автоматически обновляется при следующей операции

### Настройка TTL

TTL можно изменить в `pyproject.toml`:

```toml
[tool.valutatrade]
rates_ttl_seconds = 3600  # 1 час
```

### Принудительное обновление

Если нужно обновить курсы принудительно:

```bash
update-rates
```

## Безопасность

- **Пароли** хранятся с использованием SHA-256 + соль (32 байта)
- **Минимальная длина пароля** — 4 символа
- **API ключи** загружаются из `.env` (файл не добавляется в Git)

## Логирование

Все операции логируются в `logs/actions.log` с ротацией:
- Максимальный размер файла: 10 МБ
- Количество резервных копий: 5

Пример лога:
```
INFO 2026-01-14T15:30:42 BUY user='alice' currency='BTC' amount=0.1000 rate=59337.21 base='USD' balance_change=0.0000->0.1000 result=OK
INFO 2026-01-14T15:32:15 SELL user='alice' currency='EUR' amount=100.0000 rate=1.08 base='USD' balance_change=1000.0000->900.0000 result=OK
```

## Разработка

### Проверка стиля кода

```bash
make lint
```

### Сборка пакета

```bash
make build
```

### Публикация (dry-run)

```bash
make publish
```

### Установка собранного пакета

```bash
make package-install
```

### Удаление пакета

```bash
make package-uninstall
```

## Поддерживаемые валюты

### Фиатные валюты
- USD (Доллар США)
- EUR (Евро)
- GBP (Фунт стерлингов)
- RUB (Российский рубль)

### Криптовалюты
- BTC (Bitcoin)
- ETH (Ethereum)
- SOL (Solana)

## Обработка ошибок

Приложение корректно обрабатывает:
- **Недостаточно средств** — при попытке продажи
- **Неизвестная валюта** — с выводом списка поддерживаемых
- **Ошибки API** — timeout, rate limit (429), unauthorized (401)
- **Невалидные данные** — неверный формат команд

Пример обработки ошибки:
```bash
> sell --currency BTC --amount 10
Ошибка: Недостаточно средств: доступно 0.1 BTC, требуется 10.0 BTC
```
